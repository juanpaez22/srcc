<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stone Ranch Command Center</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header class="site-header">
            <div class="logo-section">
                <img src="/static/longhorn.png" class="logo-img" alt="Stone Ranch">
                <h1>Stone Ranch Command Center</h1>
            </div>
            <nav class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/chores_page">Chores</a>
                <a href="/telemetry">Tracker</a>
            </nav>
        </header>

        <main class="main-content">
            <section class="welcome-section">
                <h2>Welcome to Stone Ranch</h2>
                <p class="date" id="current-date"></p>
            </section>

            <section class="card weather-card">
                <h2>{{ weather_city }} Weather</h2>
                <div class="weather-current">
                    <div class="weather-main">
                        <span class="temp" id="temp">--</span>
                        <span class="degree">¬∞F</span>
                    </div>
                    <div class="weather-details">
                        <span class="condition" id="condition">Loading...</span>
                        <span class="wind">Wind: <span id="wind">--</span> mph</span>
                    </div>
                </div>
                <div class="weather-forecast" id="forecast"></div>
            </section>

            <section class="card stocks-card">
                <h2>Stocks</h2>
                <div class="stocks-grid" id="stocks-grid">
                    <span class="stocks-loading">Loading...</span>
                </div>
            </section>

            <section class="card life-card" id="life-card">
                <h2>Personal Metrics</h2>
                <div class="life-grid" id="life-grid">
                    <div class="life-loading">Loading...</div>
                </div>
            </section>

            <section class="card journal-card" id="journal-card">
                <h2>üìù Recent Journal</h2>
                <div id="journal-entry">
                    <span class="journal-loading">Loading...</span>
                </div>
            </section>

            <section class="chores-section card" id="overdue-section" style="display: none;">
                <h2 style="color: #f44336;">‚ö†Ô∏è Overdue Chores</h2>
                <ul class="chores-list" id="overdue-list"></ul>
            </section>

            <section class="chores-section card" id="chores-section" style="display: none;">
                <h2>Today's Chores</h2>
                <ul class="chores-list" id="chores-list"></ul>
            </section>

            <section class="ai-section">
                <h3>ü§ñ AI & Tech News</h3>
                <div class="ai-cards" id="ai-digest"></div>
            </section>

            <section class="news-section">
                <h3>üì∞ Daily Digest</h3>
                <div class="digest-grid" id="news-digest"></div>
            </section>

            <section class="card future-improvements-card" id="future-improvements-card">
                <h3>üöß Future Improvements</h3>
                <div class="future-tasks" id="future-tasks">
                    <span class="loading">Loading...</span>
                </div>
            </section>
        </main>

        <footer class="telemetry">
            <h3>System Status</h3>
            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-label">CPU</span>
                    <span class="stat-value" id="cpu">--%</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Memory</span>
                    <span class="stat-value" id="memory">--%</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Uptime</span>
                    <span class="stat-value" id="uptime">--</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Updated</span>
                    <span class="stat-value" id="time">--:--:--</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Last Bevo Tend</span>
                    <span class="stat-value" id="last_tend">--</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Bevo</span>
                    <span class="stat-value" id="bevo-version">--</span>
                </div>
            </div>
        </footer>
    </div>

    <script>
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        const weatherCodes = {
            0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
            45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
            51: 'üåßÔ∏è', 53: 'üåßÔ∏è', 55: 'üåßÔ∏è',
            61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
            71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è',
            80: 'üå¶Ô∏è', 81: 'üå¶Ô∏è', 82: 'üå¶Ô∏è',
            95: '‚õàÔ∏è', 96: '‚õàÔ∏è'
        };

        function updateStats() {
            fetch('/stats')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('cpu').textContent = data.cpu + '%';
                    document.getElementById('memory').textContent = data.memory + '%';
                    document.getElementById('uptime').textContent = data.uptime || '--';
                    document.getElementById('time').textContent = data.time;
                    document.getElementById('last_tend').textContent = data.last_tend_time || 'Never';
                })
                .catch(() => {
                    document.getElementById('last_tend').textContent = 'Error';
                });
            
            // Fetch nanobot version
            fetch('/nanobot/releases')
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('bevo-version').textContent = 'Error';
                        return;
                    }
                    const version = 'v' + data.latest_version;
                    if (data.is_new) {
                        document.getElementById('bevo-version').innerHTML = `${version} <span style="color:#4caf50">‚¨Ü update</span>`;
                    } else {
                        document.getElementById('bevo-version').textContent = version + ' ‚úì';
                    }
                })
                .catch(() => {
                    document.getElementById('bevo-version').textContent = '--';
                });
        }

        function updateWeather() {
            fetch('/weather')
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('condition').textContent = 'Error';
                        return;
                    }
                    document.getElementById('temp').textContent = data.temp;
                    document.getElementById('condition').textContent = data.condition;
                    document.getElementById('wind').textContent = data.wind;
                    
                    const forecast = document.getElementById('forecast');
                    forecast.innerHTML = data.forecast.map(f => 
                        `<div class="forecast-hour"><span class="f-time">${f.time}</span><span class="f-icon">${weatherCodes[f.code] || 'üå°Ô∏è'}</span><span class="f-temp">${f.temp}¬∞</span></div>`
                    ).join('');
                });
        }

        function updateStocks() {
            fetch('/stocks')
                .then(r => r.json())
                .then(data => {
                    const grid = document.getElementById('stocks-grid');
                    if (data.stocks.length === 0) {
                        grid.innerHTML = '<span>Unable to load stocks</span>';
                        return;
                    }
                    grid.innerHTML = data.stocks.map(s => `
                        <div class="stock-item">
                            <span class="stock-symbol">${s.symbol}</span>
                            <span class="stock-price">$${s.price}</span>
                            <span class="stock-change ${s.change >= 0 ? 'up' : 'down'}">${s.change >= 0 ? '+' : ''}${s.change_pct}%</span>
                        </div>
                    `).join('');
                });
        }

        function updateNews() {
            // AI-specific news section
            fetch('/digest')
                .then(r => r.json())
                .then(data => {
                    const aiTheme = data.themes && data.themes.find(t => 
                        t.theme.toLowerCase().includes('ai') || 
                        t.theme.toLowerCase().includes('tech')
                    );
                    
                    if (aiTheme && aiTheme.headlines && aiTheme.headlines.length > 0) {
                        let aiHtml = '<div class="ai-card-grid">';
                        aiTheme.headlines.slice(0, 6).forEach(h => {
                            const wordCount = h.title.split(' ').length;
                            const readTime = Math.max(1, Math.ceil(wordCount / 200));
                            aiHtml += `<div class="ai-card">
                                <a href="${h.link}" target="_blank">
                                    <div class="ai-card-title">${h.title}</div>
                                    <div class="ai-card-meta">${h.source} ¬∑ ${readTime}m</div>
                                </a>
                            </div>`;
                        });
                        aiHtml += '</div>';
                        document.getElementById('ai-digest').innerHTML = aiHtml;
                    } else {
                        document.getElementById('ai-digest').innerHTML = '<span>No AI news available</span>';
                    }
                })
                .catch(() => {
                    document.getElementById('ai-digest').innerHTML = '<span>Unable to load AI news</span>';
                });
            
            // General news digest
            fetch('/digest')
                .then(r => r.json())
                .then(data => {
                    if (data.error || !data.themes) {
                        document.getElementById('news-digest').innerHTML = '<span>Unable to load digest</span>';
                        return;
                    }
                    
                    let html = '<div class="digest-cards">';
                    data.themes.forEach(theme => {
                        // Skip empty themes
                        if (!theme.headlines || theme.headlines.length === 0) return;
                        
                        // Get emoji based on theme
                        let emoji = 'üì∞';
                        const t = theme.theme.toLowerCase();
                        if (t.includes('ai') || t.includes('tech')) emoji = 'ü§ñ';
                        else if (t.includes('sport')) emoji = '‚öΩ';
                        else if (t.includes('business') || t.includes('econom')) emoji = 'üìà';
                        else if (t.includes('world')) emoji = 'üåç';
                        else if (t.includes('politics') || t.includes('government')) emoji = 'üèõÔ∏è';
                        
                        html += `<div class="digest-card">
                            <h4 class="digest-card-title">${emoji} ${theme.theme}</h4>
                            <ul class="digest-headlines">`;
                        theme.headlines.slice(0, 5).forEach(h => {
                            const wordCount = h.title.split(' ').length;
                            const readTime = Math.max(1, Math.ceil(wordCount / 200));
                            html += `<li class="digest-headline">
                                <a href="${h.link}" target="_blank">${h.title}</a>
                                <span class="digest-meta">${h.source} ¬∑ ${readTime}m</span>
                            </li>`;
                        });
                        html += '</ul></div>';
                    });
                    html += '</div>';
                    document.getElementById('news-digest').innerHTML = html;
                });
        }

        function updateChores() {
            fetch('/chores')
                .then(r => r.json())
                .then(data => {
                    // Today's chores
                    const section = document.getElementById('chores-section');
                    const list = document.getElementById('chores-list');
                    
                    if (data.chores.length > 0) {
                        section.style.display = 'block';
                        list.innerHTML = data.chores.map(c => `<li>${c}</li>`).join('');
                    } else {
                        section.style.display = 'none';
                    }
                    
                    // Overdue chores
                    const overdueSection = document.getElementById('overdue-section');
                    const overdueList = document.getElementById('overdue-list');
                    
                    if (data.overdue && data.overdue.length > 0) {
                        overdueSection.style.display = 'block';
                        overdueList.innerHTML = data.overdue.map(c => `<li>${c}</li>`).join('');
                    } else {
                        overdueSection.style.display = 'none';
                    }
                });
        }

        function updateLifeMetrics() {
            Promise.all([
                fetch('/life/streaks').then(r => r.json()),
                fetch('/life/mood').then(r => r.json()),
                fetch('/life/fitness').then(r => r.json()),
                fetch('/life/learning').then(r => r.json()),
                fetch('/life/social').then(r => r.json())
            ])
            .then(([streaks, mood, fitness, learning, social]) => {
                const grid = document.getElementById('life-grid');
                
                // Fitness streak
                const streak = streaks.fitness || {};
                const streakDays = streak.current_streak || 0;
                const weeklyCount = streak.weekly_count || 0;
                const weeklyTarget = streak.weekly_target || 4;
                const weeklyPct = Math.min(100, (weeklyCount / weeklyTarget) * 100);
                
                // Mood
                const moodData = mood.entries && mood.entries[0];
                const moodValue = moodData ? moodData.mood : null;
                const moodEmoji = moodValue >= 8 ? 'üòä' : moodValue >= 5 ? 'üòê' : moodValue ? 'üòî' : '‚Äî';
                const moodLabel = moodValue ? `${moodValue}/10` : 'No data';
                
                // Last workout
                const workouts = fitness.workouts || [];
                const lastWorkout = workouts.length > 0 ? workouts[workouts.length - 1].date : null;
                
                // Learning
                const learningData = learning.entries || [];
                const lastLearning = learningData.length > 0 ? learningData[learningData.length - 1].activity : 'No data';
                
                // Social
                const socialData = social.entries || [];
                const lastSocial = socialData.length > 0 ? socialData[socialData.length - 1].activity : 'No data';
                
                grid.innerHTML = `
                    <div class="life-item">
                        <span class="life-icon">üí™</span>
                        <span class="life-label">Gym Streak</span>
                        <span class="life-value">${streakDays} days</span>
                    </div>
                    <div class="life-item">
                        <span class="life-icon">üìÖ</span>
                        <span class="life-label">This Week</span>
                        <span class="life-value">${weeklyCount}/${weeklyTarget}</span>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${weeklyPct}%"></div></div>
                    </div>
                    <div class="life-item">
                        <span class="life-icon">${moodEmoji}</span>
                        <span class="life-label">Mood</span>
                        <span class="life-value">${moodLabel}</span>
                    </div>
                    <div class="life-item">
                        <span class="life-icon">üèãÔ∏è</span>
                        <span class="life-label">Last Workout</span>
                        <span class="life-value">${lastWorkout || 'Never'}</span>
                    </div>
                    <div class="life-item">
                        <span class="life-icon">üìö</span>
                        <span class="life-label">Learning</span>
                        <span class="life-value">${lastLearning}</span>
                    </div>
                    <div class="life-item">
                        <span class="life-icon">üë•</span>
                        <span class="life-label">Social</span>
                        <span class="life-value">${lastSocial}</span>
                    </div>
                `;
            })
            .catch(err => {
                document.getElementById('life-grid').innerHTML = '<span class="life-error">Unable to load metrics</span>';
            });
        }

        function updateJournal() {
            fetch('/journal')
            .then(r => r.json())
            .then(data => {
                const entry = data.entries && data.entries[0];
                const container = document.getElementById('journal-entry');
                if (entry) {
                    container.innerHTML = `
                        <p class="journal-prompt">${entry.prompt}</p>
                        <p class="journal-text">${entry.text || 'No entry'}</p>
                        <span class="journal-date">${entry.date}</span>
                    `;
                } else {
                    container.innerHTML = '<span class="journal-empty">No journal entries yet</span>';
                }
            })
            .catch(() => {
                document.getElementById('journal-entry').innerHTML = '<span class="journal-error">Unable to load journal</span>';
            });
        }

        function updateFutureTasks() {
            fetch('/rancher/tasks')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('future-tasks');
                if (data.active_tasks && data.active_tasks.length > 0) {
                    const tasksHtml = data.active_tasks.map(task => 
                        `<div class="future-task-item">${task}</div>`
                    ).join('');
                    container.innerHTML = `<div class="tasks-list">${tasksHtml}</div>`;
                } else {
                    container.innerHTML = '<span class="empty">All caught up! üéâ</span>';
                }
            })
            .catch(() => {
                document.getElementById('future-tasks').innerHTML = '<span class="error">Unable to load tasks</span>';
            });
        }

        updateStats();
        updateWeather();
        updateStocks();
        updateNews();
        updateChores();
        updateLifeMetrics();
        updateJournal();
        updateFutureTasks();
        setInterval(updateStats, 3000);
        setInterval(updateWeather, 300000);
        setInterval(updateStocks, 60000);
        setInterval(updateNews, 300000);
    </script>
</body>
</html>
